
<html>
  <head>
    <script src="jquery.min.js"></script>
  </head>
  <body>
    <div id="game">
      <span id="score">0</span><br>
      <span id="status"></span><br>
    </div>
    <script>
      $(function() {
        game = new Game();

        $(document).keydown(function(e) {
          switch(e.which) {
            case 37: // left
              game.moveBlock(-1);
              break;

            case 38: // up
              game.turnBlock();
              break;

            case 39: // right
              game.moveBlock(1);
              break;

            case 40: // down
              game.accelarate();
              break;

            default: return; // exit this handler for other keys
          }
          e.preventDefault(); // prevent the default action (scroll / move caret)
        });
      });

      var timer = 500;

      function Game() {
        this.board = new Board();
        this.score = 0;

        this.pulse = function() {
          if (this.board.getBlock()) {
            this.board.dropBlock();

            setTimeout((function () { this.pulse(); }).bind(this), timer);
          } else {
            $('#status').append('<p>Game over!</p>');
          }
        }

        this.accelarate = function() {
          if (this.board.getBlock()) {
            this.board.dropBlock();
          }
        }

        this.moveBlock = function(xd) {
          if (this.board.getBlock()) {
            this.board.moveBlock(xd, 0);
          }
        }

        this.turnBlock = function() {
          if (this.board.getBlock()) {
            this.board.turnBlock();
          }
        }

        $(this.board).bind('linesDestroyed', { score: this.score }, function(event, n) {
          if (n > 0) {
            switch (n) {
              case 1:
                event.data.score += 40;
                break;
              case 2:
                event.data.score += 100;
                break;
              case 3:
                event.data.score += 300;
                break;
              case 4:
                event.data.score += 1200;
                break;
            }

            $('#score').text(event.data.score);
          }
        });

        this.pulse();
      }

      function Board() {
        this.height = 20;
        this.width = 10;
        this.activeBlock = null;

        this.self = new Array();

        for (var h = 0; h < this.height; h++) {
          var row = new Array();
          for (var w = 0; w < this.width; w++) {
            row[w] = false;
          }
          this.self[h] = row;
        }

        this.draw = function () {
          for (var h = 0; h < this.height; h++) {
            for (var w = 0; w < this.width; w++) {
              var chk = $(':checkbox#' + h + 'x' + w);
              if (chk.length === 0) {
                $('#game').append(input(h,w));
                if (w === this.width - 1)
                  $('#game').append('<br>');
              }

              chk.prop('checked', this.self[h][w]);
            }
          }
        }

        this.toggleBlock = function(val) {
          for (var h = 0; h < this.activeBlock.self.length; h++) {
            for (var w = 0; w < this.activeBlock.self[0].length; w++) {
              var y = this.activeBlock.y + h;
              var x = this.activeBlock.x + w;
              if (y >= 0 && y < this.height &&
                  x >= 0 && x < this.width) {
                this.self[y][x] = this.activeBlock.self[h][w] === 1 ? val : this.self[y][x];
              }
            }
          }
        }

        this.dropBlock = function() {
          //If block cannot be dropped further reset active block,
          // this will trigger a new block on next pulse
          if (!this.moveBlock(0,1)) {
            this.activeBlock = null;
            this.destroyLines();
          }

          return 0;
        }

        this.getBlock = function() {
          if (!this.activeBlock) {
            if (this.self[0][this.width/2 - 1]) //Starting position not free
              return false;

            var initialBlocks = [9, 6, 4, 0, 17, 11, 15];
            var next = initialBlocks[Math.floor(Math.random() * initialBlocks.length)];
            this.activeBlock = new Block(next);

            this.activeBlock.x = this.width/2 - 1;
            this.activeBlock.y = 0 - this.activeBlock.self.length;
          }

          this.draw();
          return this.activeBlock;
        }

        this.moveBlock = function(xd,yd) {
          if (xd !== 0 || yd !== 0) {

            //Toggle block off and move to new position
            this.toggleBlock(false);
            this.activeBlock.x += xd;
            this.activeBlock.y += yd;

            var collisionDetected = this.detectCollision();
            if (collisionDetected)
            {
              //Revert block to previous position
              this.activeBlock.x -= xd;
              this.activeBlock.y -= yd;
            }

            //Return result of movement
            this.toggleBlock(true);
            this.draw();
            return !collisionDetected;
          }

          return true;
        }

        this.turnBlock = function() {
          this.toggleBlock(false);
          var previousPosition = this.activeBlock;
          this.activeBlock = new Block(this.activeBlock.next);
          this.activeBlock.y = previousPosition.y;
          this.activeBlock.x = previousPosition.x;

          if (this.detectCollision()) {
            this.activeBlock = previousPosition;
          }

          this.toggleBlock(true);
          this.draw();
        }

        this.detectCollision = function() {
          for (var h = 0; h < this.activeBlock.self.length; h++) {
            for (var w = 0; w < this.activeBlock.self[0].length; w++) {
              var x = this.activeBlock.x + w;
              var y = this.activeBlock.y + h;

              //Ignore part of the board not yet visible
              if (y < 0)
                continue;

              if (y >= this.height || x < 0 || x >= this.width  ||
                  this.activeBlock.self[h][w] === 1 && this.self[y][x]) {
                return true;
              }
            }
          }

          return false;
        }

        this.destroyLines = function() {
          var n = 0;
          var first = 0;
          for (var h = this.height - 1; h >= 0; h--) {
            var rowComplete = true;
            for (var w = 0; w < this.width; w++) {
              if (!this.self[h][w]) {
                rowComplete = false;
                break;
              }
            }

            if (rowComplete) {
              n++;

              if (n === 1) {
                first = h;
              }
              else if (n === 4)
                break;
            }
          }

          if (n > 0) {
            for (var h = first; h >= 0; h--) {
              for (var w = 0; w < this.width; w++) {
                this.self[h][w] = h - n < 0 ? false : this.self[h - n][w];
              }
            }

            this.draw();

            $(this).trigger('linesDestroyed', [n]);
          }
        }

        function input(h,w,checked) {
          return '<input id="' + h + 'x' + w + '" type="checkbox" disabled="disabled" style="margin: -1px;"/>';
        }
      }

      function Block(n) {
        this.next;

        switch(n){
          case 0:
            this.self = [
              [1, 1],
              [1, 1]
            ];
            this.next = 0;
            break;
          case 1:
            this.self = [
              [1, 0],
              [1, 0],
              [1, 1]
            ];
            this.next = 2;
            break;
          case 2:
            this.self = [
              [1, 1, 1],
              [1, 0, 0]
            ];
            this.next = 3;
            break;
          case 3:
            this.self = [
              [1, 1],
              [0, 1],
              [0, 1]
            ];
            this.next = 4;
            break;
          case 4:
            this.self = [
              [0, 0, 1],
              [1, 1, 1]
            ];
            this.next = 1;
            break;
          case 5:
            this.self = [
              [0, 1],
              [0, 1],
              [1, 1]
            ];
            this.next = 6;
            break;
          case 6:
            this.self = [
              [1, 0, 0],
              [1, 1, 1]
            ];
            this.next = 7;
            break;
          case 7:
            this.self = [
              [1, 1],
              [1, 0],
              [1, 0]
            ];
            this.next = 8;
            break;
          case 8:
            this.self = [
              [1, 1, 1],
              [0, 0, 1]
            ];
            this.next = 5;
            break;
          case 9:
            this.self = [
              [1, 1, 1, 1]
            ];
            this.next = 10;
            break;
          case 10:
            this.self = [
              [1],
              [1],
              [1],
              [1]
            ];
            this.next = 9;
            break;
          case 11:
            this.self = [
              [0, 1, 0],
              [1, 1, 1]
            ];
            this.next = 12;
            break;
          case 12:
            this.self = [
              [1, 0],
              [1, 1],
              [1, 0]
            ];
            this.next = 13;
            break;
          case 13:
            this.self = [
              [1, 1, 1],
              [0, 1, 0]
            ];
            this.next = 14;
            break;
          case 14:
            this.self = [
              [0, 1],
              [1, 1],
              [0, 1]
            ];
            this.next = 11;
            break;
          case 15:
            this.self = [
              [1, 1, 0],
              [0, 1, 1]
            ];
            this.next = 16;
            break;
          case 16:
            this.self = [
              [0, 1],
              [1, 1],
              [1, 0]
            ];
            this.next = 15;
            break;
          case 17:
            this.self = [
              [0, 1, 1],
              [1, 1, 0]
            ];
            this.next = 18;
            break;
          case 18:
            this.self = [
              [1, 0],
              [1, 1],
              [0, 1]
            ];
            this.next = 17;
            break;
        }
      }
    </script>
  </body>
</htm>
